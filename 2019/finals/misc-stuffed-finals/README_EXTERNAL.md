# License of this file

Copyright 2019 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

# Stuffed

Create a highly compressed brotli file that contains the flag, and serve it
with the content encoding header.

## How to change the flag

The flag is embedded in the `bomb.br` file. So to change the flag, the file needs
to be regenerated. The file is generated by the `make.py` file. `make.py`
contains code that inserts the flag, and generates part of the flag by repeating
a previous portion of the flag. So the flag needs to contain a repeating portion
that can be expressed this way.

Once `make.py` is modified, run it and it will create a new `bomb.br` file.
Takes about 6 minutes.

    ./make.py

By default the `DIVIDER` variable is 1, meaning the output is 81MB, and the
uncompressed data is 100TB.

## How to solve

### Fast way

    cd solution
    ./solve.sh

This patches a couple lines in the brotli decoder to omit large repeats. The
actual decompression then only takes 2.8s.

### Slow way

`dec.py` with the `--only_short` flag decompresses a brotli file ignoring large
metablocks. Run it on `bomb.br` and it will output the flag. Takes about 5
minutes.

    ./dec.py bomb.br bomb_extracted.html --only_short

Of course the players will need to first get the `bomb.br` file.

    curl https://stuffed.web.ctfcompetition.com/ -H 'Accept-Encoding: br' > \
        bomb.br

That assumes curl doesn't try to decompress it automatically. My curl doesn't
try to decompress it automatically, so it works for me.

## Test that brotli is formatted correctly

If you want to verify that a browser could show the flag with infinite compute
power, then change the `DIVIDER` variable to 1000000 to get a 700B brotli file
that decompresses to 100MB. This is essentially `bomb_small.br` .
Serve this, and browsers should show the flag.

## App Engine Flex

App Engine Flex is used so that a custom Content-Encoding header can be sent.
App Engine Standard
[doesn't allow that](https://cloud.google.com/appengine/docs/standard/python/reference/request-response-headers#headers_removed).

We use an 81MB static file in App Engine Flex. The help docs
[recommend against that](https://cloud.google.com/appengine/quotas#Code), but it
has worked for us so far.
