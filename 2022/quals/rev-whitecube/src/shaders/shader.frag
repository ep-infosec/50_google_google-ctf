#version 460

// Copyright 2022 Google LLC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     https://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

// Author: Carl Svensson

const int c1 = 1024;
const int c2 = 4*4;
const int c3 = 4*4*c2;
const int c4 = c1 / c2;
const int c5 = c1 / c3 ;

layout (location = 0) out vec4 FragColor;

layout (location = 0) uniform uvec2 u_resolution;
layout (location = 1) uniform uint u_block_count;
layout (location = 2) uniform mat4 u_nonce[16];

layout(std430, binding = 0) buffer input_data
{
    mat4 data[];
};

const mat4 m0[16] = mat4[](
    mat4(97.0, 15.0, 52.0, 185.0, 99.0, 64.0, 43.0, 201.0, 230.0, 107.0, 122.0, 236.0, 168.0, 189.0, 150.0, 145.0),
    mat4(121.0, 45.0, 186.0, 66.0, 240.0, 74.0, 206.0, 29.0, 47.0, 250.0, 37.0, 174.0, 200.0, 253.0, 0.0, 53.0),
    mat4(161.0, 19.0, 128.0, 228.0, 90.0, 170.0, 155.0, 169.0, 131.0, 8.0, 122.0, 40.0, 166.0, 187.0, 62.0, 167.0),
    mat4(230.0, 32.0, 19.0, 18.0, 241.0, 213.0, 243.0, 81.0, 25.0, 62.0, 171.0, 232.0, 229.0, 152.0, 163.0, 71.0),
    mat4(66.0, 249.0, 233.0, 93.0, 230.0, 166.0, 237.0, 203.0, 63.0, 197.0, 230.0, 103.0, 241.0, 197.0, 238.0, 85.0),
    mat4(38.0, 103.0, 159.0, 162.0, 48.0, 157.0, 174.0, 218.0, 99.0, 64.0, 119.0, 170.0, 15.0, 65.0, 30.0, 75.0),
    mat4(9.0, 141.0, 21.0, 74.0, 87.0, 223.0, 0.0, 176.0, 218.0, 248.0, 1.0, 89.0, 129.0, 4.0, 169.0, 6.0),
    mat4(155.0, 143.0, 94.0, 179.0, 49.0, 102.0, 195.0, 35.0, 127.0, 140.0, 55.0, 230.0, 38.0, 83.0, 199.0, 159.0),
    mat4(32.0, 79.0, 97.0, 239.0, 220.0, 107.0, 170.0, 220.0, 26.0, 46.0, 84.0, 148.0, 42.0, 107.0, 117.0, 50.0),
    mat4(174.0, 213.0, 71.0, 205.0, 150.0, 19.0, 248.0, 198.0, 139.0, 249.0, 64.0, 220.0, 21.0, 96.0, 117.0, 218.0),
    mat4(150.0, 237.0, 154.0, 21.0, 129.0, 60.0, 63.0, 208.0, 159.0, 253.0, 153.0, 133.0, 80.0, 110.0, 246.0, 174.0),
    mat4(250.0, 138.0, 193.0, 41.0, 190.0, 15.0, 103.0, 64.0, 185.0, 18.0, 4.0, 96.0, 91.0, 208.0, 54.0, 176.0),
    mat4(219.0, 240.0, 70.0, 191.0, 149.0, 203.0, 33.0, 255.0, 251.0, 104.0, 34.0, 204.0, 120.0, 165.0, 248.0, 54.0),
    mat4(143.0, 0.0, 218.0, 117.0, 212.0, 146.0, 38.0, 102.0, 45.0, 51.0, 194.0, 158.0, 108.0, 25.0, 61.0, 149.0),
    mat4(157.0, 83.0, 170.0, 85.0, 128.0, 18.0, 117.0, 154.0, 77.0, 41.0, 178.0, 85.0, 54.0, 96.0, 15.0, 118.0),
    mat4(191.0, 254.0, 38.0, 124.0, 239.0, 246.0, 1.0, 16.0, 51.0, 82.0, 53.0, 246.0, 2.0, 181.0, 181.0, 196.0)
);

const mat4 m1[16] = mat4[](
    mat4(102.0, 148.0, 54.0, 11.0, 113.0, 233.0, 219.0, 96.0, 196.0, 70.0, 128.0, 97.0, 7.0, 143.0, 123.0, 211.0),
    mat4(244.0, 136.0, 121.0, 170.0, 112.0, 186.0, 107.0, 182.0, 241.0, 255.0, 97.0, 18.0, 233.0, 243.0, 247.0, 13.0),
    mat4(88.0, 127.0, 108.0, 173.0, 31.0, 8.0, 220.0, 183.0, 2.0, 167.0, 119.0, 47.0, 14.0, 135.0, 210.0, 34.0),
    mat4(0.0, 162.0, 51.0, 235.0, 36.0, 59.0, 108.0, 40.0, 198.0, 130.0, 199.0, 106.0, 127.0, 23.0, 35.0, 63.0),
    mat4(214.0, 22.0, 220.0, 102.0, 195.0, 88.0, 98.0, 195.0, 54.0, 194.0, 105.0, 161.0, 211.0, 111.0, 122.0, 191.0),
    mat4(116.0, 29.0, 140.0, 27.0, 120.0, 3.0, 90.0, 76.0, 111.0, 86.0, 110.0, 83.0, 129.0, 78.0, 71.0, 206.0),
    mat4(204.0, 57.0, 106.0, 196.0, 180.0, 96.0, 139.0, 10.0, 127.0, 52.0, 56.0, 91.0, 130.0, 149.0, 200.0, 38.0),
    mat4(57.0, 138.0, 146.0, 127.0, 254.0, 242.0, 98.0, 235.0, 96.0, 115.0, 223.0, 233.0, 214.0, 115.0, 8.0, 194.0),
    mat4(218.0, 11.0, 116.0, 135.0, 150.0, 40.0, 241.0, 236.0, 76.0, 128.0, 42.0, 87.0, 9.0, 62.0, 32.0, 133.0),
    mat4(115.0, 73.0, 201.0, 105.0, 138.0, 22.0, 234.0, 169.0, 165.0, 221.0, 138.0, 225.0, 112.0, 157.0, 200.0, 38.0),
    mat4(249.0, 80.0, 72.0, 162.0, 84.0, 145.0, 190.0, 189.0, 221.0, 143.0, 26.0, 114.0, 18.0, 69.0, 211.0, 230.0),
    mat4(245.0, 158.0, 15.0, 44.0, 168.0, 14.0, 248.0, 50.0, 254.0, 8.0, 12.0, 192.0, 24.0, 191.0, 174.0, 32.0),
    mat4(243.0, 166.0, 79.0, 32.0, 198.0, 115.0, 254.0, 55.0, 4.0, 160.0, 137.0, 201.0, 13.0, 124.0, 57.0, 238.0),
    mat4(250.0, 75.0, 137.0, 218.0, 27.0, 84.0, 10.0, 136.0, 194.0, 102.0, 33.0, 98.0, 236.0, 132.0, 28.0, 2.0),
    mat4(219.0, 219.0, 48.0, 232.0, 73.0, 211.0, 252.0, 225.0, 239.0, 229.0, 164.0, 246.0, 179.0, 147.0, 139.0, 176.0),
    mat4(44.0, 155.0, 91.0, 224.0, 10.0, 182.0, 78.0, 87.0, 22.0, 255.0, 202.0, 149.0, 84.0, 15.0, 47.0, 16.0)
);

const mat4 m2[16] = mat4[](
    mat4(102.0, 85.0, 19.0, 195.0, 140.0, 247.0, 54.0, 25.0, 9.0, 246.0, 179.0, 52.0, 159.0, 186.0, 204.0, 57.0),
    mat4(146.0, 201.0, 231.0, 2.0, 171.0, 161.0, 63.0, 78.0, 34.0, 209.0, 147.0, 121.0, 115.0, 206.0, 254.0, 112.0),
    mat4(44.0, 220.0, 249.0, 115.0, 3.0, 57.0, 250.0, 38.0, 165.0, 214.0, 62.0, 183.0, 41.0, 223.0, 41.0, 194.0),
    mat4(149.0, 3.0, 230.0, 174.0, 212.0, 115.0, 47.0, 244.0, 189.0, 34.0, 50.0, 101.0, 106.0, 169.0, 2.0, 130.0),
    mat4(203.0, 40.0, 210.0, 103.0, 32.0, 174.0, 27.0, 100.0, 231.0, 168.0, 203.0, 105.0, 58.0, 129.0, 52.0, 110.0),
    mat4(231.0, 167.0, 103.0, 212.0, 158.0, 125.0, 166.0, 164.0, 156.0, 216.0, 72.0, 241.0, 217.0, 234.0, 142.0, 62.0),
    mat4(49.0, 78.0, 76.0, 16.0, 33.0, 143.0, 91.0, 176.0, 90.0, 78.0, 150.0, 111.0, 94.0, 129.0, 233.0, 221.0),
    mat4(14.0, 212.0, 128.0, 18.0, 65.0, 246.0, 105.0, 41.0, 176.0, 227.0, 96.0, 190.0, 61.0, 204.0, 173.0, 201.0),
    mat4(17.0, 237.0, 24.0, 111.0, 110.0, 169.0, 96.0, 146.0, 143.0, 212.0, 199.0, 40.0, 237.0, 124.0, 221.0, 36.0),
    mat4(125.0, 199.0, 26.0, 199.0, 200.0, 11.0, 76.0, 39.0, 159.0, 159.0, 109.0, 160.0, 26.0, 201.0, 55.0, 26.0),
    mat4(76.0, 204.0, 245.0, 147.0, 66.0, 213.0, 171.0, 245.0, 10.0, 17.0, 230.0, 49.0, 1.0, 23.0, 224.0, 151.0),
    mat4(144.0, 161.0, 7.0, 84.0, 11.0, 27.0, 13.0, 32.0, 136.0, 71.0, 28.0, 154.0, 254.0, 167.0, 75.0, 12.0),
    mat4(123.0, 248.0, 247.0, 60.0, 201.0, 90.0, 195.0, 245.0, 191.0, 43.0, 225.0, 14.0, 240.0, 137.0, 147.0, 192.0),
    mat4(65.0, 103.0, 198.0, 54.0, 218.0, 174.0, 170.0, 134.0, 71.0, 5.0, 113.0, 222.0, 185.0, 239.0, 213.0, 201.0),
    mat4(214.0, 54.0, 42.0, 187.0, 3.0, 68.0, 16.0, 146.0, 182.0, 58.0, 32.0, 101.0, 80.0, 50.0, 60.0, 57.0),
    mat4(1.0, 146.0, 133.0, 202.0, 2.0, 243.0, 93.0, 45.0, 27.0, 75.0, 4.0, 75.0, 128.0, 175.0, 63.0, 247.0)
);

const mat4 m3[16] = mat4[](
    mat4(212.0, 51.0, 251.0, 31.0, 136.0, 37.0, 62.0, 3.0, 54.0, 242.0, 184.0, 241.0, 35.0, 228.0, 61.0, 203.0),
    mat4(164.0, 217.0, 127.0, 198.0, 44.0, 235.0, 143.0, 129.0, 202.0, 154.0, 239.0, 95.0, 26.0, 242.0, 110.0, 175.0),
    mat4(87.0, 220.0, 116.0, 20.0, 50.0, 40.0, 147.0, 16.0, 22.0, 2.0, 99.0, 232.0, 190.0, 147.0, 185.0, 61.0),
    mat4(80.0, 99.0, 165.0, 180.0, 248.0, 130.0, 48.0, 48.0, 43.0, 116.0, 182.0, 73.0, 96.0, 211.0, 61.0, 117.0),
    mat4(106.0, 160.0, 232.0, 156.0, 177.0, 234.0, 3.0, 191.0, 73.0, 113.0, 72.0, 34.0, 154.0, 60.0, 94.0, 168.0),
    mat4(246.0, 83.0, 169.0, 21.0, 180.0, 197.0, 92.0, 249.0, 203.0, 39.0, 154.0, 91.0, 131.0, 70.0, 109.0, 234.0),
    mat4(56.0, 245.0, 82.0, 175.0, 133.0, 53.0, 141.0, 91.0, 9.0, 123.0, 29.0, 145.0, 105.0, 248.0, 183.0, 22.0),
    mat4(178.0, 206.0, 43.0, 128.0, 45.0, 189.0, 36.0, 18.0, 112.0, 175.0, 125.0, 252.0, 213.0, 62.0, 113.0, 237.0),
    mat4(49.0, 0.0, 254.0, 128.0, 120.0, 152.0, 100.0, 73.0, 65.0, 23.0, 255.0, 44.0, 68.0, 115.0, 9.0, 219.0),
    mat4(99.0, 250.0, 175.0, 18.0, 30.0, 161.0, 7.0, 179.0, 225.0, 142.0, 98.0, 92.0, 200.0, 94.0, 212.0, 220.0),
    mat4(96.0, 156.0, 68.0, 49.0, 215.0, 136.0, 67.0, 45.0, 215.0, 186.0, 152.0, 47.0, 140.0, 73.0, 176.0, 179.0),
    mat4(239.0, 206.0, 117.0, 93.0, 177.0, 39.0, 194.0, 78.0, 66.0, 221.0, 150.0, 147.0, 78.0, 76.0, 25.0, 139.0),
    mat4(43.0, 90.0, 117.0, 187.0, 117.0, 108.0, 232.0, 204.0, 101.0, 62.0, 25.0, 214.0, 50.0, 83.0, 43.0, 151.0),
    mat4(172.0, 96.0, 136.0, 109.0, 167.0, 8.0, 33.0, 79.0, 103.0, 251.0, 180.0, 214.0, 33.0, 116.0, 141.0, 11.0),
    mat4(117.0, 123.0, 161.0, 60.0, 79.0, 104.0, 82.0, 76.0, 149.0, 32.0, 56.0, 160.0, 173.0, 112.0, 174.0, 184.0),
    mat4(36.0, 81.0, 20.0, 81.0, 165.0, 159.0, 126.0, 171.0, 52.0, 14.0, 5.0, 126.0, 176.0, 175.0, 99.0, 88.0)
);


void f3(out mat4 res[16], in mat4 a[16], in mat4 b[16]) {
    res[0] = a[0]*b[0] + a[1]*b[4] + a[2]*b[8] + a[3]*b[12];
    res[1] = a[0]*b[1] + a[1]*b[5] + a[2]*b[9] + a[3]*b[13];
    res[2] = a[0]*b[2] + a[1]*b[6] + a[2]*b[10] + a[3]*b[14];
    res[3] = a[0]*b[3] + a[1]*b[7] + a[2]*b[11] + a[3]*b[15];
    res[4] = a[4]*b[0] + a[5]*b[4] + a[6]*b[8] + a[7]*b[12];
    res[5] = a[4]*b[1] + a[5]*b[5] + a[6]*b[9] + a[7]*b[13];
    res[6] = a[4]*b[2] + a[5]*b[6] + a[6]*b[10] + a[7]*b[14];
    res[7] = a[4]*b[3] + a[5]*b[7] + a[6]*b[11] + a[7]*b[15];
    res[8] = a[10]*b[8] + a[11]*b[12] + a[8]*b[0] + a[9]*b[4];
    res[9] = a[10]*b[9] + a[11]*b[13] + a[8]*b[1] + a[9]*b[5];
    res[10] = a[10]*b[10] + a[11]*b[14] + a[8]*b[2] + a[9]*b[6];
    res[11] = a[10]*b[11] + a[11]*b[15] + a[8]*b[3] + a[9]*b[7];
    res[12] = a[12]*b[0] + a[13]*b[4] + a[14]*b[8] + a[15]*b[12];
    res[13] = a[12]*b[1] + a[13]*b[5] + a[14]*b[9] + a[15]*b[13];
    res[14] = a[12]*b[2] + a[13]*b[6] + a[14]*b[10] + a[15]*b[14];
    res[15] = a[12]*b[3] + a[13]*b[7] + a[14]*b[11] + a[15]*b[15];
}

void f4(inout mat4 data[16], in int val) {
   for(int i = 0; i < 16; i++) {
     for(int col = 0; col < 4; col++) {
       for(int row = 0; row < 4; row++) {
         data[i][col][row] = float(val);
       }
     }
   }
}

void f5(inout mat4 data[16]) {
   for(int i = 0; i < 16; i++) {
     for(int col = 0; col < 4; col++) {
       for(int row = 0; row < 4; row++) {
         data[i][col][row] = mod(data[i][col][row], 256.0);
       }
     }
   }
}

void f6(out mat4 dst[16], in mat4 src[16]) {
    for(int i = 0; i < 16; i++) {
        dst[i] = src[i];
    }
}

void f7(inout mat4 dst[16], in mat4 src[16]) {
    for(int i = 0; i < 16; i++) {
        dst[i] += src[i];
    }
}

void f7(out mat4 res[16], in mat4 a[16], in mat4 b[16]) {
    for(int i = 0; i < 16; i++) {
        res[i] = a[i] + b[i];
    }
}

void f8(inout mat4 dst[16], in mat4 src[16]) {
    for(int i = 0; i < 16; i++) {
        dst[i] -= src[i];
    }
}

void f0(out mat4 dst[16], in mat4 m[16], in mat4 k[16]) {
    mat4 tmp[16];
    for(int i = 0; i < 16; i++) {
        for(int col = 0; col < 4; col++) {
            for(int row = 0; row < 4; row++) {
                tmp[i][col][row] = float(int(126.0 * (1.0+sin(m[i][col][row]))));
            }
        }
    }
    f5(tmp);
    f3(dst, tmp, k);
}

void f1(out mat4 dst[16], in mat4 m[16], in mat4 k[16]) {
    mat4 tmp[16];
    for(int i = 0; i < 16; i++) {
        for(int col = 0; col < 4; col++) {
            for(int row = 0; row < 4; row++) {
                tmp[i][col][row] = float(int(126.0 * (1.0+cos(m[i][col][row]))));
            }
        }
    }
    f5(tmp);
    f3(dst, tmp, k);
}

void f2(out mat4 dst[16], in mat4 m[16], in mat4 k[16]) {
    mat4 tmp[16];
    for(int i = 0; i < 16; i++) {
        for(int col = 0; col < 4; col++) {
            for(int row = 0; row < 4; row++) {
                tmp[i][col][row] = float(int(126.0 * (1.0+tan((m[i][col][row]-127.0)/256.0))));
            }
        }
    }
    f5(tmp);
    f3(dst, tmp, k);
}

void main()
{
    const uint v0 = (u_resolution.x * int(gl_FragCoord.y) + int(gl_FragCoord.x))*4;
    const uint v1 = (v0 / 4) % 4;
    const uint v2 = v0 / c1;
    const uint v3 = (v0 % c1) / c3;
    const uint v4 = v0 % c3;
    const uint v5 = v4 / c2;

    const uint v6 = (v2 * c1)/c2;

    if(v2 >= u_block_count) {
        FragColor = vec4(float(0xCC)/255.0, float(0xCC)/255.0, float(0xCC)/255.0, float(0xCC)/255.0);
        return;
    }

    mat4 nonce[16];
    f6(nonce, u_nonce);
    nonce[15][0][0] = float(2*(v2+1)-1);

    mat4 m4[16];
    uint v7;
    uint v8;

    mat4 m5[16];

    // Create modifier block and get input offset
    if(v3 == 0) {
        v7 = 1 * c3/c2;
        v8 = 0 * c3/c2;
    } else if(v3 == 1) {
        v7 = 2 * c3/c2;
        v8 = 1 * c3/c2;
    } else if(v3 == 2) {
        v7 = 3 * c3/c2;
        v8 = 2 * c3/c2;
    } else if(v3 == 3) {
        v7 = 0 * c3/c2;
        v8 = -1;
    }

    // Init M0
    if(v3 >= 0 && v3 <= 2) {
        m4[0] = data[v6 + v8 + 0];
        m4[1] = data[v6 + v8 + 1];
        m4[2] = data[v6 + v8 + 2];
        m4[3] = data[v6 + v8 + 3];
        m4[4] = data[v6 + v8 + 4];
        m4[5] = data[v6 + v8 + 5];
        m4[6] = data[v6 + v8 + 6];
        m4[7] = data[v6 + v8 + 7];
        m4[8] = data[v6 + v8 + 8];
        m4[9] = data[v6 + v8 + 9];
        m4[10] = data[v6 + v8 + 10];
        m4[11] = data[v6 + v8 + 11];
        m4[12] = data[v6 + v8 + 12];
        m4[13] = data[v6 + v8 + 13];
        m4[14] = data[v6 + v8 + 14];
        m4[15] = data[v6 + v8 + 15];
    } else { // v3 == 3
        f4(m4, 0);
    }

    if(v3 == 0) {
        f0(m4, m4, m1);
    } else if(v3 == 1) {
        f1(m4, m4, m2);
    } else if(v3 == 2) {
        f2(m4, m4, m3);
    }

    // Fetch input block
    m5[0] = data[v6 + v7 + 0];
    m5[1] = data[v6 + v7 + 1];
    m5[2] = data[v6 + v7 + 2];
    m5[3] = data[v6 + v7 + 3];
    m5[4] = data[v6 + v7 + 4];
    m5[5] = data[v6 + v7 + 5];
    m5[6] = data[v6 + v7 + 6];
    m5[7] = data[v6 + v7 + 7];
    m5[8] = data[v6 + v7 + 8];
    m5[9] = data[v6 + v7 + 9];
    m5[10] = data[v6 + v7 + 10];
    m5[11] = data[v6 + v7 + 11];
    m5[12] = data[v6 + v7 + 12];
    m5[13] = data[v6 + v7 + 13];
    m5[14] = data[v6 + v7 + 14];
    m5[15] = data[v6 + v7 + 15];

    // apply F-function
    f5(m4);
    f7(m5, m4);
    f5(m5);

    // Apply nonce and diffusion
    f3(m5, m5, nonce);
    f5(m5);
    f3(m5, m5, m0);
    f5(m5);

    // Convert to "bytes"
    FragColor = vec4(
        float(m5[v5][0][v1])/255.0,
        float(m5[v5][1][v1])/255.0,
        float(m5[v5][2][v1])/255.0,
        float(m5[v5][3][v1])/255.0
    );
}
